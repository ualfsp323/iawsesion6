# iaw-practica-06
### Práctica 6 de IAW
<div id='id6' />

### **Por Franco Sergio Pereyra 2º ASIR**
# **Índice**
* 1.- [ Frontend_Socket_Unix](#id1)
* 2.- [ Frontend_Socket_Tcp](#id2)
* 3.- [Backend](#id3)
<div id='id1' />

## 1.- Frontend_Socket_Unix 
### 1.1 Añadimos la ip Privada de nuestro Backend
```bash
#/bin/bash
set -x
#----------------------------------------------------

#----------------------------------------------------
# Variables de configuración 
#----------------------------------------------------
# Configuramos 
IP_MYSQL=172.31.83.131

#----------------------------------------------------

```
### 1.1.- Instalamos la pila LEMP con los cambios echos en el fichero default_socket_unix
```bash
#----------------------------------------------------
# Instalacíon de la pila LEMP (Solución 1: Unix en la misma máquina)
#----------------------------------------------------
# Actualizamos el sistema
apt update
# apt upgrade -y

# Instalamos El servidor NGINX
apt install nginx -y

# Instalamos el php-fpm y php-mysql
apt install php-fpm -y
apt install php-mysql -y


# Configuración de Nginx
cp conf/default_socket_unix /etc/nginx/sites-available/default
systemctl restart nginx
```

```bash
# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.php index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	# pass PHP scripts to FastCGI server
	#
	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
	
		# With php-fpm (or other unix sockets):
		fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
		# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	location ~ /\.ht {
		deny all;
	}
}

```

### 1.2.- Desplegamos la aplicación web
```bash

#--------------------------------------
# Despliege de la aplicacion web
#--------------------------------------
cd /var/www/html

# Clonamos el repositorio de la aplicación
git clone https://github.com/josejuansanchez/iaw-practica-lamp.git

#Movemos el codigo fuente de la aplicación al directorio /var/www/html

mv iaw-practica-lamp/src/* /var/www/html


# Eliminamos el archivo index.html
rm /var/www/html/index.html

# Eliminamos el directorio del repositorio
rm -rf /var/www/html/iaw-practica-lamp

#Configuramos la dirección IP de MYSQL en el archivo de configuración
sed -i "s/localhost/$IP_MYSQL/" /var/www/html/config.php


# Cambiamos el propietario y el grupo
chown www-data:www-data /var/www/html -R 


#Cambiamos el nombre de la Homepage

sed -i "s/Simple LAMP web app/Simple LAMP web app Fronted Nº2/" /var/www/html/index.php
```
<div id='id2' />

## 2.- Frontend_Socket_Tcp 
### 2.1 Añadimos la ip Privada de nuestro Backend
```bash
#/bin/bash
set -x
#----------------------------------------------------

#----------------------------------------------------
# Variables de configuración 
#----------------------------------------------------
# Configuramos 
IP_MYSQL=172.31.83.131

#----------------------------------------------------

```
### 2.1.- Instalamos la pila LEMP con los cambios echos en el fichero default_socket_tcp
```bash
#----------------------------------------------------
# Instalacíon de la pila LEMP (Solución 2: Socket TCP en la misma máquina)
#----------------------------------------------------
# Actualizamos el sistema
apt update
# apt upgrade -y

# Instalamos El servidor NGINX
apt install nginx -y

# Instalamos el php-fpm y php-mysql
apt install php-fpm -y
apt install php-mysql -y


# Configuración de Nginx
cp conf/default_socket_tcp /etc/nginx/sites-available/default
```

```bash
# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.php index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	# pass PHP scripts to FastCGI server
	#
	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
	
		# With php-fpm (or other unix sockets):
		#fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
		# With php-cgi (or other tcp sockets):
        fastcgi_pass 127.0.0.1:9000;
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	location ~ /\.ht {
		deny all;
	}
}

```
### 2.2.- Configuración de php-fmp
```bash
# Configuración de php-fmp
sed -i "s#/run/php/php7.4-fpm.sock#127.0.0.1:9000#" /home/ubuntu/iaw-practica-06/conf/www.conf
cp conf/www.conf /etc/php/7.4/fpm/pool.d 
systemctl restart php7.4-fpm
```

```bash
; The address on which to accept FastCGI requests.
; Valid syntaxes are:
;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on
;                            a specific port;
;   '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on
;                            a specific port;
;   'port'                 - to listen on a TCP socket to all addresses
;                            (IPv6 and IPv4-mapped) on a specific port;
;   '/path/to/unix/socket' - to listen on a unix socket.
; Note: This value is mandatory.
listen = 127.0.0.1:9000
```

### 2.3.- Desplegamos la aplicación web
```bash
#--------------------------------------
# Despliege de la aplicacion web
#--------------------------------------
cd /var/www/html

# Clonamos el repositorio de la aplicación
git clone https://github.com/josejuansanchez/iaw-practica-lamp.git

#Movemos el codigo fuente de la aplicación al directorio /var/www/html

mv iaw-practica-lamp/src/* /var/www/html


# Eliminamos el archivo index.html
rm /var/www/html/index.html

# Eliminamos el directorio del repositorio
rm -rf /var/www/html/iaw-practica-lamp

#Configuramos la dirección IP de MYSQL en el archivo de configuración
sed -i "s/localhost/$IP_MYSQL/" /var/www/html/config.php


# Cambiamos el propietario y el grupo
chown www-data:www-data /var/www/html -R 


#Cambiamos el nombre de la Homepage

sed -i "s/Simple LAMP web app/Simple LAMP web app Fronted Nº1/" /var/www/html/index.php
```

<div id='id3' />

## 3.- Backend (Añadimos solamente la base de Datos)
```bash
#/bin/bash
set -x
#----------------------------------------------------

#----------------------------------------------------
# Variables de configuración 
#----------------------------------------------------

MYSQL_ROOT_PASSWORD=root

#----------------------------------------------------
```
### 3.1.- Instalamos la pila LAMP(Solo el mysql)
```bash
#----------------------------------------------------
# Instalacíon de la pila LAMP
#----------------------------------------------------
# Actualizamos el sistema
apt update
apt upgrade -y


# Instalamos MySQL Server
apt install mysql-server -y

# Cambiamos la contraseña del usuario root
mysql <<< "ALTER USER root@'localhost' IDENTIFIED WITH caching_sha2_password BY '$MYSQL_ROOT_PASSWORD';"

# Configuramos MySQL para aceptar conexiones desde cualquier interfaz de red
sed -i "s/127.0.0.1/0.0.0.0/" /etc/mysql/mysql.conf.d/mysqld.cnf

# Reiniciamos el servicio de MySQL
systemctl restart mysql
```
### 3.2.- Desplegamos la aplicación web
```bash
#--------------------------------------
# Despliege de la aplicacion web
#--------------------------------------
cd /tmp

# Clonamos el repositorio de la aplicación
rm -rf /tmp/iaw-practica-lamp
git clone https://github.com/josejuansanchez/iaw-practica-lamp.git

#Movemos el codigo fuente de la aplicación al directorio /var/www/html


# Importamos el script de basde de datos
mysql -u root -p$MYSQL_ROOT_PASSWORD < /tmp/iaw-practica-lamp/db/database.sql

# Eliminamos el directorio del repositorio
rm -rf /tmp/iaw-practica-lamp
```

[Volver hacia arriba](#id6)
